<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel del Decano</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
<style>
    body {
        margin: 0;
        font-family: 'Arial', sans-serif;
        background: url('{{ url_for("static", filename="fondo_paisaje.jpg") }}') no-repeat center center fixed;
        background-size: cover;
    }
    .container {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(8px);
        max-width: 600px;
        margin: 60px auto;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.35);
        position: relative;
        z-index: 2;
    }
    h2 { text-align:center; margin-bottom:30px; font-size:28px; color:#003366; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
    label { display:block; margin-top:15px; font-weight:bold; color:#004080; }
    input, select, button {
        width:100%; padding:12px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:16px;
        transition: all 0.3s ease;
    }
    input:focus, select:focus { outline:none; border-color:#0066cc; box-shadow:0 0 8px rgba(0,102,204,0.3); }
    button {
        background: linear-gradient(135deg,#004080,#0066cc); color:white; font-weight:bold; border:none; cursor:pointer;
        margin-top:25px; transition: all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,0.2);
    }
    button:hover { background: linear-gradient(135deg,#0066cc,#004080); transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.3); }
    #vista_vigencia,#nombre_persona,#dni_persona { font-weight:bold; color:#004080; }
    a { display:block; text-align:center; margin-top:20px; color:#004080; font-weight:bold; }
    a:hover { text-decoration:underline; }

    /* AUTOCOMPLETE */
    #sugerencias li { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
    #sugerencias li:hover { background-color:#f0f8ff; }
    #sugerencias {
        list-style:none; padding:0; margin:5px 0 0 0; max-height:120px; overflow-y:auto;
        border:1px solid #ccc; display:none; background:#fff; border-radius:6px;
    }

    /* FOTO */
    #foto_persona { max-width:200px; display:none; border-radius:8px; margin-top:10px; border:1px solid #ccc; }

    /* MODAL */
    .modal {
        display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
        background: rgba(0,0,0,0.65); display:flex; justify-content:center; align-items:center; animation:fadeIn 0.3s ease;
    }
    .modal-content {
        background:#fff; padding:30px; border-radius:14px; max-width:450px; text-align:center;
        box-shadow:0 12px 30px rgba(0,0,0,0.4); transform:translateY(-20px); animation:slideUp 0.4s ease forwards;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes slideUp { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
    .modal h3 { color:#d9534f; margin-bottom:18px; font-size:22px; }
    .modal p { font-size:16px; margin-bottom:20px; line-height:1.5; }
    .modal button {
        width:48%; margin:8px 2%; padding:12px; font-weight:bold; border-radius:8px; border:none; cursor:pointer; transition:all 0.3s ease;
    }
    #cancelBtn { background:#ccc; color:#333; }
    #cancelBtn:hover { background:#999; color:white; }
    #confirmBtn { background:linear-gradient(135deg,#d9534f,#c9302c); color:white; }
    #confirmBtn:hover { background:linear-gradient(135deg,#c9302c,#a92723); }

    /* ---------------- DATOS Y FOTO AL COSTADO ---------------- */
#info_container {
    display: flex;
    align-items: flex-start; /* Alinea arriba */
    gap: 20px; /* Espacio entre datos y foto */
}

#foto_persona {
    border-radius: 8px;
    border: 1px solid #ccc;
    display: none; /* Se mostrar√° solo si hay foto */
    width: 150px;
}

</style>
</head>
<body>

<div class="container">
    <h2>Panel del Decano ‚Äì Emisi√≥n de Certificados</h2>

    <form id="formPDF">
        <label>Buscar por DNI</label>
        <input type="text" name="dni" id="dni" placeholder="Ingrese DNI">

        <label>O buscar por Nombre</label>
        <input type="text" name="nombre" id="nombre" placeholder="Ingrese nombre completo" autocomplete="off">
        <ul id="sugerencias"></ul>

        <label>Mes de vigencia</label>
        <select id="mes" required>
            <option value="">-- Seleccionar mes --</option>
            <option value="ENERO">ENERO</option>
            <option value="FEBRERO">FEBRERO</option>
            <option value="MARZO">MARZO</option>
            <option value="ABRIL">ABRIL</option>
            <option value="MAYO">MAYO</option>
            <option value="JUNIO">JUNIO</option>
            <option value="JULIO">JULIO</option>
            <option value="AGOSTO">AGOSTO</option>
            <option value="SEPTIEMBRE">SEPTIEMBRE</option>
            <option value="OCTUBRE">OCTUBRE</option>
            <option value="NOVIEMBRE">NOVIEMBRE</option>
            <option value="DICIEMBRE">DICIEMBRE</option>
            <option value="VITALICIO">VITALICIO</option>
        </select>

        <label>A√±o</label>
        <select id="anio" required>
            {% for y in range(2026, 2029) %}
            <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
        </select>

        <input type="hidden" name="fecha_vencimiento_input" id="vigencia_final">

        <div id="info_container" style="display:flex; align-items:flex-start; gap:20px; margin-top:10px;">
            <div id="datos_texto">
                <p><strong>Nombre:</strong> <span id="nombre_persona">‚Äî</span></p>
                <p><strong>DNI:</strong> <span id="dni_persona">‚Äî</span></p>
                <p><strong>Vigencia:</strong> <span id="vista_vigencia">‚Äî</span></p>
                <p><strong>N¬∞ Colegiatura:</strong> <span id="colegiatura_persona">‚Äî</span></p>
            </div>
        <div id="foto_container">
        <img id="foto_persona" src="" alt="Foto del colegiado" style="width:150px; border-radius:8px; display:none;">
    </div>
</div>


        <button type="submit">üìÑ Generar certificado</button>
    </form>

    <a href="/logout">Cerrar sesi√≥n</a>
</div>

<!-- MODAL CONFIRMACI√ìN PDF -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Confirmar antes de generar PDF</h3>
        <p id="modalTexto"></p>
        <button id="cancelBtn">Cancelar</button>
        <button id="confirmBtn">Confirmar</button>
    </div>
</div>

<script>
const dniInput = document.getElementById("dni");
const nombreInput = document.getElementById("nombre");
const mes = document.getElementById("mes");
const anio = document.getElementById("anio");
const vigenciaFinal = document.getElementById("vigencia_final");
const vista = document.getElementById("vista_vigencia");
const nombrePersona = document.getElementById("nombre_persona");
const dniPersona = document.getElementById("dni_persona");
const colegiaturaPersona = document.getElementById("colegiatura_persona");
const fotoPersona = document.getElementById("foto_persona");
const sugerencias = document.getElementById("sugerencias");

const formPDF = document.getElementById("formPDF");
const modal = document.getElementById("confirmModal");
const modalTexto = document.getElementById("modalTexto");
const cancelBtn = document.getElementById("cancelBtn");
const confirmBtn = document.getElementById("confirmBtn");

// ---------------- Actualiza vigencia ----------------
function actualizarVigencia(){
    if(mes.value && anio.value){
        const texto = mes.value + " DE " + anio.value;
        vigenciaFinal.value = texto;
        vista.textContent = texto;
    }
}
mes.addEventListener("change", actualizarVigencia);
anio.addEventListener("change", actualizarVigencia);

// ---------------- Buscar por DNI ----------------
dniInput.addEventListener("blur", async () => {
    const dni = dniInput.value.trim();
    if(!dni) return;
    try{
        const res = await fetch("/buscar_dni_admin", {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ dni })
        });
        const data = await res.json();
        if(data.success){
            nombrePersona.textContent = data.nombres_apellidos;
            dniPersona.textContent = dni;
            colegiaturaPersona.textContent = data.colegiatura || "‚Äî";
            nombreInput.value = data.nombres_apellidos;

            if(data.foto_url){
                fotoPersona.src = data.foto_url;
                fotoPersona.style.display="block";
            } else {
                fotoPersona.src="";
                fotoPersona.style.display="none";
            }

        } else {
            nombrePersona.textContent="No encontrado";
            dniPersona.textContent="‚Äî";
            fotoPersona.src="";
            fotoPersona.style.display="none";
        }
    } catch(err){ console.error(err); }
});

// ---------------- Autocompletado por nombre ----------------
nombreInput.addEventListener("input", () => {
    const texto = nombreInput.value.trim();
    if(!texto){ sugerencias.style.display="none"; return; }
    fetch("/buscar_nombre_admin", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nombre:texto })
    })
    .then(res => res.json())
    .then(data => {
        sugerencias.innerHTML="";
        if(data.success && data.resultados.length>0){
            data.resultados.forEach(r => {
                const li = document.createElement("li");
                li.textContent = r.nombres_apellidos;
                li.addEventListener("click", ()=>{
                    nombreInput.value=r.nombres_apellidos;
                    nombrePersona.textContent=r.nombres_apellidos;
                    dniPersona.textContent=r.DNI;
                    dniInput.value=r.DNI;
                    colegiaturaPersona.textContent = r.colegiatura || "‚Äî";


                    if(r.foto_url){
                        fotoPersona.src=r.foto_url;
                        fotoPersona.style.display="block";
                    } else {
                        fotoPersona.src="";
                        fotoPersona.style.display="none";
                    }
                    sugerencias.style.display="none";
                });
                sugerencias.appendChild(li);
            });
            sugerencias.style.display="block";
        } else { sugerencias.style.display="none"; }
    })
    .catch(err => { console.error(err); sugerencias.style.display="none"; });
});

// ---------------- Modal y generar PDF ----------------
formPDF.addEventListener("submit", function(e){
    e.preventDefault();
    if(!vigenciaFinal.value){ alert("Seleccione mes y a√±o de vigencia"); return; }
    if(nombrePersona.textContent==="No encontrado" || !nombrePersona.textContent){ alert("Ingrese un DNI o nombre v√°lido"); return; }

    modalTexto.innerHTML = `
        DNI: <strong>${dniPersona.textContent}</strong><br>
        Nombre: <strong>${nombrePersona.textContent}</strong><br>
        Vigencia: <strong>${vigenciaFinal.value}</strong>
    `;
    modal.style.display="flex";
});

cancelBtn.addEventListener("click", ()=> modal.style.display="none");

confirmBtn.addEventListener("click", ()=>{
    modal.style.display="none";
    const formData = new FormData(formPDF);
    fetch("/pdf",{method:"POST", body:formData})
    .then(res=>res.blob())
    .then(blob=>{
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href=url;
        a.download="certificado_comap_" + dniPersona.textContent + ".zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
    })
    .catch(err => alert("Error al generar PDF"));
});
</script>

</body>
</html>
