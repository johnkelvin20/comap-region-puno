<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel del Decano</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS externo (opcional si ya lo tienes) -->
<link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">

<!-- ---------------- BLOQUE DE ESTILOS INTERNOS ---------------- -->
<style>
/* Fondo y tipograf√≠a general */
body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background: url('{{ url_for("static", filename="fondo_paisaje.jpg") }}') no-repeat center center fixed;
    background-size: cover;
}

/* Contenedor principal */
.container {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(8px);
    max-width: 600px;
    margin: 60px auto;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    position: relative;
    z-index: 2;
}

/* T√≠tulos y etiquetas */
h2 { text-align:center; margin-bottom:30px; font-size:28px; color:#003366; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
label { display:block; margin-top:15px; font-weight:bold; color:#004080; }

/* Inputs, select y botones */
input, select, button {
    width:100%; padding:12px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:16px;
    transition: all 0.3s ease;
}
input:focus, select:focus { outline:none; border-color:#0066cc; box-shadow:0 0 8px rgba(0,102,204,0.3); }
button {
    background: linear-gradient(135deg,#004080,#0066cc); color:white; font-weight:bold; border:none; cursor:pointer;
    margin-top:25px; transition: all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
button:hover { background: linear-gradient(135deg,#0066cc,#004080); transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.3); }

/* Autocomplete */
#sugerencias li { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
#sugerencias li:hover { background-color:#f0f8ff; }
#sugerencias { list-style:none; padding:0; margin:5px 0 0 0; max-height:120px; overflow-y:auto; border:1px solid #ccc; display:none; background:#fff; border-radius:6px; }

/* Foto del colegiado */
#foto_persona.foto-carnet{
    width: 130px;
    height: 170px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: #f2f2f2;
    display: block;
}

/* Modal de confirmaci√≥n */
.modal {
    display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
    background: rgba(0,0,0,0.65); display:flex; justify-content:center; align-items:center; animation:fadeIn 0.3s ease;
}
.modal-content {
    background:#fff; padding:30px; border-radius:14px; max-width:450px; text-align:center;
    box-shadow:0 12px 30px rgba(0,0,0,0.4); transform:translateY(-20px); animation:slideUp 0.4s ease forwards;
}
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
@keyframes slideUp { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
.modal h3 { color:#d9534f; margin-bottom:18px; font-size:22px; }
.modal p { font-size:16px; margin-bottom:20px; line-height:1.5; }
.modal button { width:48%; margin:8px 2%; padding:12px; font-weight:bold; border-radius:8px; border:none; cursor:pointer; transition:all 0.3s ease; }
#cancelBtn { background:#ccc; color:#333; }
#cancelBtn:hover { background:#999; color:white; }
#confirmBtn { background:linear-gradient(135deg,#d9534f,#c9302c); color:white; }
#confirmBtn:hover { background:linear-gradient(135deg,#c9302c,#a92723); }

/* Datos y foto al costado */
#info_container { display:flex; align-items:flex-start; gap:20px; }
#datos_texto { text-align: left; }

.btn-cerrar {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #999, #666);
    color: white;
    font-weight: bold;
    cursor: pointer;
}



</style>
<!-- ---------------- FIN BLOQUE DE ESTILOS ---------------- -->
</head>



<body>
<div class="container">
    <h2>Panel del Decano ‚Äì Emisi√≥n de Certificados</h2>

    <!-- ---------------- BLOQUE FORMULARIO ---------------- -->
    <form id="formPDF">

        <!-- 1Ô∏è‚É£ Buscar por DNI o nombre -->
        <label>Buscar por DNI o Nombre</label>
        <input type="text" id="busqueda" placeholder="Ingrese DNI o nombre completo" autocomplete="off">
        <input type="hidden" name="dni" id="dni">
        <ul id="sugerencias"></ul>
        <input type="hidden" id="fila_persona">

        <!-- 2Ô∏è‚É£ Mostrar datos y foto -->
        <div id="info_container" style="display:flex; align-items:flex-start; gap:20px; margin-top:10px;">
            <div id="foto_container">
                <img id="foto_persona"
                    class="foto-carnet"
                    src="{{ url_for('static', filename='avatar_neutro_carnet.png') }}"
                    alt="Foto del colegiado">
            </div>

            <div id="datos_texto">
                <p><strong>Nombre:</strong> <span id="nombre_persona">‚Äî</span></p>
                <p><strong>DNI:</strong> <span id="dni_persona">‚Äî</span></p>
                <p><strong>Vigencia:</strong> <span id="prevVigencia">‚Äî</span></p>
                <p><strong>N¬∞ Colegiatura:</strong> <span id="colegiatura_persona">‚Äî</span></p>
            </div>
        </div>

        <!-- 3Ô∏è‚É£ Nueva fecha de vigencia -->
        <label>Nueva fecha de vigencia</label>
        <input type="date" id="fecha_vigencia" required>

        <!-- 4Ô∏è‚É£ Bot√≥n actualizar -->
        <button type="button" id="btnActualizar">üîÑ Actualizar vigencia</button>

        <!-- 5Ô∏è‚É£ Mostrar vigencia seleccionada -->
        <p>
            <strong>Vigencia seleccionada:</strong>
            <span id="vista_vigencia">‚Äî</span>
        </p>
        <input type="hidden" name="fecha_vencimiento_input" id="vigencia_final">
        <input type="hidden" name="vigencia_pdf" id="vigencia_pdf">

        <!-- 6Ô∏è‚É£ Generar certificado -->
        <button type="submit">üìÑ Generar certificado</button>
    </form>
<!-- ---------------- FIN BLOQUE FORMULARIO ---------------- -->


<button type="button" class="btn-cerrar" id="btnCerrarVentana">
    ‚ùå Cerrar ventana
</button>



</div>




<!-- MODAL CONFIRMACI√ìN PDF -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Confirmar antes de generar PDF</h3>
        <p id="modalTexto"></p>
        <button id="cancelBtn">Cancelar</button>
        <button id="confirmBtn">Confirmar</button>
    </div>
</div>

<script>
const busquedaInput = document.getElementById("busqueda");
const dniInput = document.getElementById("dni");
function esDNI(texto){
    return /^\d{8}$/.test(texto);
}
const vigenciaFinal = document.getElementById("vigencia_final");
const vigenciaPDF = document.getElementById("vigencia_pdf");
const vista = document.getElementById("vista_vigencia");
const prevVigencia = document.getElementById("prevVigencia");
const nombrePersona = document.getElementById("nombre_persona");
const dniPersona = document.getElementById("dni_persona");
const colegiaturaPersona = document.getElementById("colegiatura_persona");
const fotoPersona = document.getElementById("foto_persona");
const sugerencias = document.getElementById("sugerencias");
const fechaInput = document.getElementById("fecha_vigencia");
const btnActualizar = document.getElementById("btnActualizar");

const mesesTexto = [
  "ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO",
  "JULIO","AGOSTO","SETIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"
];
function fechaATextoMes(fechaDDMMYYYY){
  // espera "28/02/2026"
  const partes = (fechaDDMMYYYY || "").split("/");
  if(partes.length !== 3) return (fechaDDMMYYYY || "").toUpperCase();

  const dd = partes[0];
  const mm = parseInt(partes[1], 10);
  const yyyy = partes[2];

  const meses = [
    "ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO",
    "JULIO","AGOSTO","SETIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"
  ];

  if(mm < 1 || mm > 12) return (fechaDDMMYYYY || "").toUpperCase();
  return `${meses[mm-1]} DE ${yyyy}`;
}



// No permitir fechas pasadas
const hoy = new Date().toISOString().split("T")[0];
fechaInput.min = hoy;

fechaInput.addEventListener("change", () => {
    if (!fechaInput.value) return;

    // fechaInput.value viene as√≠: "2026-02-28"
    const [yyyy, mm, dd] = fechaInput.value.split("-");

    // ‚úÖ Guardar exacto con d√≠a para Sheets
    const textoFinal = `${dd}/${mm}/${yyyy}`;  // "28/02/2026"

    vigenciaFinal.value = textoFinal;   // lo que se guarda
    vista.textContent = textoFinal;     // lo que se muestra
    vigenciaPDF.value = fechaATextoMes(textoFinal);

});



btnActualizar.addEventListener("click", async () => {

    // 1Ô∏è‚É£ Validaciones b√°sicas
    if (!dniInput.value || !document.getElementById("fila_persona").value) {
        alert("‚ùå Primero seleccione un colegiado");
        return;
    }

    if (!fechaInput.value) {
        alert("‚ùå Seleccione una fecha de vigencia");
        return;
    }

    // 2Ô∏è‚É£ Usar la fecha exacta que ya se arm√≥ en el change (DD/MM/YYYY)
    const nuevaVigencia = vigenciaFinal.value;  // "28/02/2026"

    // 3Ô∏è‚É£ Mostrar en pantalla
    vista.textContent = nuevaVigencia;


    // 4Ô∏è‚É£ Guardar en Google Sheets (SIN PDF)
    const res = await fetch("/actualizar_vigencia_admin", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            fila: document.getElementById("fila_persona").value,
            vigencia: nuevaVigencia
        })
    });

    const data = await res.json();

    if (data.success) {
        alert("‚úÖ Vigencia actualizada correctamente");
    } else {
        alert("‚ùå Error al guardar la vigencia");
    }
});



const formPDF = document.getElementById("formPDF");
const modal = document.getElementById("confirmModal");
const modalTexto = document.getElementById("modalTexto");
const cancelBtn = document.getElementById("cancelBtn");
const confirmBtn = document.getElementById("confirmBtn");





// ---------------- Autocompletado por DNI o nombre ----------------
busquedaInput.addEventListener("input", async () => {
    const texto = busquedaInput.value.trim();

    if(!texto){
        sugerencias.style.display = "none";
        return;
    }

    // üîµ SI ES DNI
    if(esDNI(texto)){
        sugerencias.style.display = "none";

        try{
            const res = await fetch("/buscar_dni_admin", {
                method:"POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ dni: texto })
            });
            const data = await res.json();

            if(data.success){
                nombrePersona.textContent = data.nombres_apellidos;
                dniPersona.textContent = texto;
                dniInput.value = texto;
                colegiaturaPersona.textContent = data.colegiatura || "‚Äî";
                vista.textContent = data.vigencia || "‚Äî";
                prevVigencia.textContent = data.vigencia || "‚Äî";
                vigenciaFinal.value = data.vigencia || "";
                


                document.getElementById("fila_persona").value = data.fila;

                fotoPersona.src = (data.foto_url && data.foto_url.trim())
                    ? data.foto_url
                    : "/static/avatar_neutro_carnet.png";

                    fotoPersona.style.display = "block";

                    fotoPersona.onerror = () => {
                    fotoPersona.src = "/static/avatar_neutro_carnet.png";
                    };

            }

        } catch(err){ console.error(err); }

        return;
    }

    // üü° SI ES NOMBRE
    fetch("/buscar_nombre_admin", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nombre: texto })
    })
    .then(res => res.json())
    .then(data => {
        sugerencias.innerHTML = "";

        if(data.success && data.resultados.length > 0){
            data.resultados.forEach(r => {
                const li = document.createElement("li");
                li.textContent = r.nombres_apellidos;

                li.addEventListener("click", () => {
                    busquedaInput.value = r.nombres_apellidos;
                    nombrePersona.textContent = r.nombres_apellidos;
                    dniPersona.textContent = r.DNI;
                    dniInput.value = r.DNI;
                    colegiaturaPersona.textContent = r.colegiatura || "‚Äî";
                    vista.textContent = r.vigencia || "‚Äî";
                    prevVigencia.textContent = r.vigencia || "‚Äî";
                    vigenciaFinal.value = r.vigencia || "";
                    document.getElementById("fila_persona").value = r.fila;

                    fotoPersona.src = (r.foto_url && r.foto_url.trim())
                        ? r.foto_url
                        : "/static/avatar_neutro_carnet.png";

                        fotoPersona.style.display = "block";

                        fotoPersona.onerror = () => {
                        fotoPersona.src = "/static/avatar_neutro_carnet.png";
                        };


                    sugerencias.style.display = "none";
                });

                sugerencias.appendChild(li);
            });

            sugerencias.style.display = "block";
        } else {
            sugerencias.style.display = "none";
        }
    })
    .catch(() => sugerencias.style.display="none");
});


// ---------------- Modal y generar PDF ----------------
formPDF.addEventListener("submit", function(e){
    e.preventDefault();
    if(!vigenciaFinal.value || !vigenciaPDF.value){
  alert("Seleccione y actualice la fecha de vigencia");
  return;
}
    if(!dniInput.value){
    alert("Seleccione un colegiado v√°lido");
    return;
}
    if(nombrePersona.textContent==="No encontrado" || !nombrePersona.textContent){ alert("Ingrese un DNI o nombre v√°lido"); return; }

    modalTexto.innerHTML = `
        DNI: <strong>${dniPersona.textContent}</strong><br>
        Nombre: <strong>${nombrePersona.textContent}</strong><br>
        Vigencia: <strong>${vigenciaPDF.value}</strong>
    `;
    modal.style.display="flex";
});

cancelBtn.addEventListener("click", ()=> modal.style.display="none");

confirmBtn.addEventListener("click", () => {
  modal.style.display = "none";
  const formData = new FormData(formPDF);

  fetch("/pdf", { method: "POST", body: formData })
    .then(response => {
      if (!response.ok) throw new Error("Error en servidor");

      // üîπ EXTRAER NOMBRE DEL HEADER
      const disposition = response.headers.get("Content-Disposition");
      let filename = "certificado.zip";

      if (disposition && disposition.includes("filename=")) {
        filename = disposition
          .split("filename=")[1]
          .replace(/"/g, "")
          .trim();
      }

      return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename; // ‚úÖ ahora s√≠, nombre correcto
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => {
      console.error(err);
      alert("Error al generar el certificado");
    });
});



document.getElementById("btnCerrarVentana")?.addEventListener("click", () => {
    window.location.href = "/";
});
 
</script>

</body>
</html>
